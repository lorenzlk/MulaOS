<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Search Results</h1>
    <div>
      <a href="/searches" class="btn btn-secondary">Back to Searches</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Search Details</h5>
      <p class="card-text"><strong>Phrase:</strong> {{search.phrase}}</p>
      <p class="card-text"><strong>Platform:</strong> {{search.platform}}</p>
      {{#if search.credentialName}}
        <p class="card-text"><strong>Credentials:</strong> <span class="badge bg-info">{{search.credentialName}}</span></p>
      {{/if}}
      <p class="card-text"><strong>Created:</strong> {{formatDate search.createdAt}}</p>
      <p class="card-text"><strong>Phrase ID:</strong> {{search.phraseID}}</p>
      <p class="card-text">
        <strong>Status:</strong> 
        {{#if (eq search.status 'pending')}}
          <span class="badge bg-warning">Pending</span>
        {{else if (eq search.status 'searching')}}
          <span class="badge bg-info">Searching</span>
        {{else if (eq search.status 'completed')}}
          <span class="badge bg-primary">Completed</span>
        {{else if (eq search.status 'approved')}}
          <span class="badge bg-success">Approved</span>
        {{else if (eq search.status 'rejected')}}
          <span class="badge bg-danger">Rejected</span>
        {{else if (eq search.status 'failed')}}
          <span class="badge bg-danger">Failed</span>
        {{else}}
          <span class="badge bg-secondary">{{search.status}}</span>
        {{/if}}
      </p>
      {{#if search.productCount}}
        <p class="card-text"><strong>Products Found:</strong> {{search.productCount}}</p>
      {{/if}}
      {{#if search.qualityScore}}
        <p class="card-text"><strong>Quality Score:</strong> {{multiply search.qualityScore 100}}%</p>
      {{/if}}
      {{#if search.keywordFeedback}}
        <p class="card-text"><strong>Feedback:</strong> {{search.keywordFeedback}}</p>
      {{/if}}
    </div>
  </div>

  {{#if (eq search.status 'completed')}}
    <div class="alert alert-warning d-flex align-items-center" role="alert">
      <i class="bi bi-clock me-2"></i>
      <div>
        <strong>Search completed - awaiting approval</strong>
        <p class="mb-0 mt-1">These search results are ready for review. Please approve or reject them.</p>
      </div>
    </div>
    <div class="d-flex gap-2 mb-4">
      <button id="approve-search-btn" class="btn btn-success">
        <i class="bi bi-check-circle me-2"></i>Approve Search
      </button>
      <button id="reject-search-btn" class="btn btn-danger">
        <i class="bi bi-x-circle me-2"></i>Reject Search
      </button>
      <button id="retry-search-btn" class="btn btn-warning">
        <i class="bi bi-arrow-clockwise me-2"></i>Retry Search
      </button>
    </div>
    <div id="search-feedback-form" class="mb-4 d-none">
      <div class="mb-3">
        <label for="searchFeedback" class="form-label">Please provide feedback for the rejected search:</label>
        <textarea class="form-control" id="searchFeedback" rows="3" placeholder="Enter your feedback here..."></textarea>
      </div>
      <button id="submit-search-feedback-btn" class="btn btn-primary">Submit Feedback</button>
    </div>
  {{/if}}

  {{#if (eq search.status 'approved')}}
    <div class="alert alert-success d-flex align-items-center" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i>
      Search has been approved and is available for use!
    </div>
  {{/if}}

  {{#if (eq search.status 'rejected')}}
    <div class="alert alert-danger d-flex align-items-center" role="alert">
      <i class="bi bi-x-circle-fill me-2"></i>
      Search has been rejected.
    </div>
    <div class="d-flex gap-2 mb-4">
      <button id="retry-search-btn" class="btn btn-warning">
        <i class="bi bi-arrow-clockwise me-2"></i>Retry Search
      </button>
    </div>
  {{/if}}

  {{#if (eq search.status 'searching')}}
    <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="bi bi-hourglass-split me-2"></i>
      Searching for products... Please wait.
    </div>
  {{/if}}

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Products</h5>
      <div id="products-container">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading products...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const productsContainer = document.getElementById('products-container');
  
  // Function to render products with optional disclaimer
  const renderProducts = (data, isTemporary = false) => {
    productsContainer.innerHTML = '';
    
    if (isTemporary) {
      const disclaimer = document.createElement('div');
      disclaimer.className = 'alert alert-warning mb-3';
      disclaimer.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Preview Results:</strong> These are temporary results that haven't been fully approved yet. 
        Final results may differ.
      `;
      productsContainer.appendChild(disclaimer);
    }
    
    if (data.shopping_results && data.shopping_results.length > 0) {
      const productsList = document.createElement('div');
      productsList.className = 'list-group';
      
      data.shopping_results.forEach(product => {
        const productItem = document.createElement('div');
        productItem.className = 'list-group-item';
        productItem.innerHTML = `
          <div class="d-flex">
            <img src="${product.thumbnail}" alt="${product.title}" class="me-3" style="width: 100px; height: 100px; object-fit: cover;">
            <div>
              <h5 class="mb-1">${product.title}</h5>
              <p class="mb-1">${product.price}</p>
              <p class="mb-1">${product.description || ''}</p>
              <a href="${product.link}" target="_blank" class="btn btn-sm btn-primary">View Product</a>
            </div>
          </div>
        `;
        productsList.appendChild(productItem);
      });
      
      productsContainer.appendChild(productsList);
    } else {
      productsContainer.innerHTML = '<p class="text-center">No products found.</p>';
    }
  };

  try {
    // First, try to get final results
    const finalResponse = await fetch(`https://cdn.makemula.ai/searches/{{search.phraseID}}/results.json`);
    if (finalResponse.ok) {
      const finalData = await finalResponse.json();
      renderProducts(finalData, false);
    } else {
      // If final results not available, try temporary results
      const tempResponse = await fetch(`https://cdn.makemula.ai/searches/{{search.phraseID}}/temp-recommendations.json`);
      if (tempResponse.ok) {
        const tempData = await tempResponse.json();
        renderProducts(tempData, true);
      } else {
        // If neither are available, show processing message
        productsContainer.innerHTML = `
          <div class="alert alert-info">
            <p class="mb-0">Results are being processed. Please check back in a few minutes.</p>
          </div>
        `;
      }
    }
    
  } catch (error) {
    // If there's an error, try temporary results as fallback
    try {
      const tempResponse = await fetch(`https://cdn.makemula.ai/searches/{{search.phraseID}}/temp-recommendations.json`);
      if (tempResponse.ok) {
        const tempData = await tempResponse.json();
        renderProducts(tempData, true);
      } else {
        // If both fail, show processing message
        productsContainer.innerHTML = `
          <div class="alert alert-info">
            <p class="mb-0">Results are being processed. Please check back in a few minutes.</p>
          </div>
        `;
      }
    } catch (tempError) {
      // If both fail, show processing message
      productsContainer.innerHTML = `
        <div class="alert alert-info">
          <p class="mb-0">Results are being processed. Please check back in a few minutes.</p>
        </div>
      `;
    }
  }

  // Search approval/rejection handlers
  const approveSearchBtn = document.getElementById('approve-search-btn');
  const rejectSearchBtn = document.getElementById('reject-search-btn');
  const retrySearchBtn = document.getElementById('retry-search-btn');
  const searchFeedbackForm = document.getElementById('search-feedback-form');
  const submitSearchFeedbackBtn = document.getElementById('submit-search-feedback-btn');

  if (approveSearchBtn) {
    approveSearchBtn.addEventListener('click', async function() {
      try {
        const response = await fetch(`/searches/{{search.id}}/approve`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (response.ok) {
          location.reload();
        } else {
          throw new Error('Failed to approve search');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to approve search. Please try again.');
      }
    });
  }

  if (rejectSearchBtn) {
    rejectSearchBtn.addEventListener('click', function() {
      searchFeedbackForm.classList.remove('d-none');
      rejectSearchBtn.disabled = true;
      approveSearchBtn.disabled = true;
    });
  }

  if (submitSearchFeedbackBtn) {
    submitSearchFeedbackBtn.addEventListener('click', async function() {
      const feedback = document.getElementById('searchFeedback').value.trim();
      if (!feedback) {
        alert('Please provide feedback before submitting.');
        return;
      }

      try {
        const response = await fetch(`/searches/{{search.id}}/reject`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ feedback })
        });

        if (response.ok) {
          location.reload();
        } else {
          throw new Error('Failed to submit feedback');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to submit feedback. Please try again.');
      }
    });
  }

  // Retry search handler
  if (retrySearchBtn) {
    retrySearchBtn.addEventListener('click', async function() {
      if (!confirm('Are you sure you want to retry this search? This will reprocess the search and may take a few minutes.')) {
        return;
      }

      try {
        retrySearchBtn.disabled = true;
        retrySearchBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Retrying...';
        
        const response = await fetch(`/searches/{{search.id}}/retry`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (response.ok) {
          const result = await response.json();
          alert('Search retry initiated successfully! The page will refresh to show the new status.');
          location.reload();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to retry search');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to retry search: ' + error.message);
        retrySearchBtn.disabled = false;
        retrySearchBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Retry Search';
      }
    });
  }
});
</script> 