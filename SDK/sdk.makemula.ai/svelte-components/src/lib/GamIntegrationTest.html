<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAM Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 40px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .widget {
            height: 200px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border: 2px dashed #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            font-size: 18px;
            color: #666;
        }
        .product-card {
            height: 100px;
            background: #f9f9f9;
            border: 1px solid #ccc;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <h1>GAM Integration Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Main Widget View Tracking</h2>
        <p>Scroll down to see the widget. GAM targeting should fire when widget is 50% visible.</p>
        <div style="height: 300px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
            <p>Scroll down to see the widget...</p>
        </div>
        <div id="mula-widget" class="widget">
            Mula Widget (50% threshold)
        </div>
        <div style="height: 300px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
            <p>Scroll up to see the widget again...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>Test 2: Product Card View Tracking</h2>
        <p>Scroll down to see product cards. GAM targeting should fire on first product view if main widget hasn't fired.</p>
        <div style="height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
            <p>Scroll down to see product cards...</p>
        </div>
        <div class="product-card" data-product-id="product-1">Product Card 1</div>
        <div class="product-card" data-product-id="product-2">Product Card 2</div>
        <div class="product-card" data-product-id="product-3">Product Card 3</div>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="testReapply()">Test Reapply GAM Targeting</button>
        <button onclick="testState()">Check GAM State</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Console Log</h2>
        <div id="log" class="log"></div>
    </div>

    <!-- Mock GPT for testing -->
    <script>
        // Mock Google Tag Manager and GPT for testing
        window.googletag = {
            pubads: () => ({
                setTargeting: (key, value) => {
                    log(`GPT setTargeting called: ${key} = ${value}`);
                }
            })
        };

        window.dataLayer = [];
        window.analytics = {
            track: (event) => {
                log(`Analytics track called: ${event}`);
            }
        };

        // Mock logger
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Test functions
        function testReapply() {
            if (window.MulaKVP && window.MulaKVP.reapply) {
                window.MulaKVP.reapply();
            } else {
                log('MulaKVP.reapply not available - using ViewTracker function');
                // This would be called from your actual ViewTracker module
                log('reapplyGamTargeting() would be called here');
            }
        }

        function testState() {
            if (window.MulaKVP) {
                log(`GAM State: initialized=${window.MulaKVP.initialized}, inViewFired=${window.MulaKVP.inViewFired}`);
            } else {
                log('MulaKVP not available - using ViewTracker state');
                // This would be called from your actual ViewTracker module
                log('getGamTrackingState() would be called here');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Initialize test
        log('GAM Integration Test initialized');
        log('Mock GPT and analytics loaded');
    </script>

    <!-- Load your ViewTracker module here -->
    <script type="module">
        // This would be your actual ViewTracker import
        // import { setupViewTracking, createProductCardViewTracker, reapplyGamTargeting, getGamTrackingState } from './ViewTracker.js';
        
        // For testing, we'll simulate the behavior
        log('ViewTracker module would be loaded here');
        
        // Simulate setupViewTracking call
        const widget = document.getElementById('mula-widget');
        if (widget) {
            log('Setting up view tracking for main widget');
            // setupViewTracking(widget, { widget: 'test-widget' });
        }
        
        // Simulate product card tracking
        const productCards = document.querySelectorAll('.product-card');
        if (productCards.length > 0) {
            log(`Setting up product card tracking for ${productCards.length} cards`);
            // const tracker = createProductCardViewTracker({ widgetLogParams: { widget: 'test-widget' } });
            // productCards.forEach(card => tracker.observe(card));
        }
    </script>
</body>
</html>
